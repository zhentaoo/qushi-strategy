<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>专业K线图表 - ECharts</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #ffffff;
            font-family: 'Arial', sans-serif;
            color: #0d1421;
        }
        
        .layout {
            display: flex;
            height: 100vh;
        }
        
        .sidebar {
            width: 260px;
            background-color: #f5f7fa;
            border-right: 1px solid #e5e7eb;
            padding: 16px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        .sidebar h2 {
            margin: 0 0 12px 0;
            font-size: 16px;
            font-weight: 500;
            color: #0d1421;
        }
        .search-box {
            display: flex;
            margin-bottom: 12px;
        }
        .search-box input {
            flex: 1;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #e5e7eb;
            background: #ffffff;
            color: #0d1421;
            outline: none;
        }
        .symbols-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .symbols-list li {
            padding: 8px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            color: #0d1421;
        }
        .symbols-list li:hover {
            background: #eef2f7;
        }
        .symbols-list li.active {
            background: #2563eb;
            color: #ffffff;
            font-weight: bold;
        }
        
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 16px;
            box-sizing: border-box;
            background: #ffffff;
        }
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        .header h1 {
            color: #0d1421;
            margin: 0;
            font-size: 18px;
            font-weight: 500;
        }
        .controls {
            display: flex;
            gap: 8px;
        }
        .controls button, .controls select {
            background-color: #f5f7fa;
            color: #0d1421;
            border: 1px solid #e5e7eb;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .controls button:hover, .controls select:hover {
            background-color: #eef2f7;
        }
        .controls button.active {
            background-color: #2563eb;
            color: #ffffff;
        }
        .chart-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 12px;
            color: #666;
            z-index: 1000;
        }
        .chart-info .info-item {
            margin: 2px 0;
        }
        .chart-info .buy-ratio {
            color: #ea4335;
            font-weight: bold;
        }
        .chart-container {
            flex: 1;
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }
        .loading {
            text-align: center;
            padding: 50px;
            color: #666666;
        }
    </style>
</head>
<body>
    <div class="layout">
        <aside class="sidebar">
            <h2>交易对</h2>
            <div class="search-box">
                <input id="searchInput" type="text" placeholder="搜索 symbol..." />
            </div>
            <ul id="symbolsList" class="symbols-list"></ul>
        </aside>
        <main class="main">
            <div class="header">
                <h1 id="title" ><a href="https://www.binance.com/zh-CN/futures/AIAUSDT" target="_blank" style="color: blue; text-decoration: none;">专业K线图表 - 币安数据</a></h1>
                <div class="controls">
                    <select id="intervalSelect">
                        <option value="5m">5m</option>
                        <option value="15m">15m</option>
                        <option value="30m">30m</option>
                        <option value="1h">1h</option>
                    </select>
                    <button data-count="100">100根</button>
                    <button data-count="200">200根</button>
                    <button data-count="500" class="active">500根</button>
                    <button data-count="1000">1000根</button>
                    <button id="refreshBtn">刷新</button>
                </div>
            </div>
            <div id="main" class="chart-container">
                <div class="loading">正在加载数据...</div>
                <div id="chartInfo" class="chart-info" style="display: none;">
                    <div class="info-item">当前主动买卖比例: <span id="currentBuyRatio" class="buy-ratio">--</span></div>
                    <div class="info-item">平均主动买卖比例: <span id="avgBuyRatio">--</span></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const chartDom = document.getElementById('main');
        const myChart = echarts.init(chartDom);
        const colors = {
            up: '#ea4335',      // 涨：红
            down: '#3b82f6',    // 跌：蓝（更柔和）
            volume: '#cfd8dc',
            buy: '#ea4335',     // 主动买入：红
            sell: '#3b82f6',    // 主动卖出：蓝（替换原绿色）
            delta: '#10b981'    // Delta Rate：淡绿色
        };
        let currentSymbol = null;
        let currentInterval = '5m';
        let currentCount = 500;
        let lastKlineData = [];
        let lastCandleReturns = [];

        const option = {
            backgroundColor: '#ffffff',
            animation: false,
            legend: {
                bottom: 10,
                left: 'center',
                data: ['K线', '主动买卖比例', '买入额', '卖出额', 'Delta Rate'],
                textStyle: { color: '#0d1421' }
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: { type: 'cross' },
                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                borderColor: '#e5e7eb',
                textStyle: { color: '#0d1421' },
                formatter: function (params) {
                    let result = '';
                    if (params.length > 0) {
                        const klinePoint = params.find(p => p.seriesName === 'K线') || params[0];
                        const idx = klinePoint.dataIndex;
                        const arr = (Array.isArray(lastKlineData) && lastKlineData[idx]) ? lastKlineData[idx] : null;
                        if (arr) {
                            const [open, close, low, high] = arr;
                            const candleReturn = (Array.isArray(lastCandleReturns) && lastCandleReturns[idx]) ? lastCandleReturns[idx] : 0;
                            const time = params[0].axisValue;
                            result += `时间: ${time}<br/>`;
                            result += `开盘: ${Number(open).toFixed(6)}<br/>`;
                            result += `收盘: ${Number(close).toFixed(6)}<br/>`;
                            result += `最低: ${Number(low).toFixed(6)}<br/>`;
                            result += `最高: ${Number(high).toFixed(6)}<br/>`;
                            result += `涨跌幅: ${Number(candleReturn).toFixed(2)}%<br/>`;
                        }
                        params.forEach(param => {
                            if (param.seriesName && param.seriesName !== 'K线') {
                                const val = Array.isArray(param.value) ? (param.value[1] ?? param.value[0] ?? param.value) : param.value;
                                if (param.seriesName === '主动买卖比例') {
                                    result += `${param.seriesName}: ${Number(val).toFixed(2)}%<br/>`;
                                } else {
                                    result += `${param.seriesName}: ${Number(val).toFixed(6)}<br/>`;
                                }
                            }
                        });
                    }
                    return result;
                }
            },
            grid: [
                { left: '10%', right: '8%', height: '62%' },
                { left: '10%', right: '8%', top: '72%', height: '18%' }
            ],
            xAxis: [
                {
                    type: 'category', data: [], boundaryGap: false, axisLine: { onZero: false }, splitLine: { show: false }, min: 'dataMin', max: 'dataMax', axisLabel: { color: '#0d1421' }
                },
                {
                    type: 'category', gridIndex: 1, data: [], boundaryGap: false, axisLine: { onZero: false }, axisTick: { show: false }, splitLine: { show: false }, axisLabel: { show: false }, min: 'dataMin', max: 'dataMax'
                }
            ],
            yAxis: [
                { 
                    scale: true, 
                    splitArea: { show: true, areaStyle: { color: ['rgba(240, 244, 248, 0.6)','rgba(240, 244, 248, 0.7)'] } }, 
                    axisLabel: { color: '#0d1421' }, 
                    splitLine: { lineStyle: { color: '#e5e7eb' } } 
                },
                { 
                    scale: true, 
                    position: 'right',
                    min: 0,
                    max: 300,
                    axisLabel: { 
                        color: '#0d1421',
                        formatter: '{value}%'
                    },
                    splitLine: { 
                        show: true,
                        lineStyle: { 
                            color: 'rgba(234, 67, 53, 0.2)',
                            type: 'dashed'
                        } 
                    }
                },
                { scale: true, gridIndex: 1, splitNumber: 2, axisLabel: { show: false }, axisLine: { show: false }, axisTick: { show: false }, splitLine: { show: false } },
                { gridIndex: 1, position: 'right', min: -50, max: 50, axisLine: { show: false }, axisTick: { show: false }, splitLine: { lineStyle: { color: '#e5e7eb' } }, axisLabel: { color: '#0d1421', formatter: '{value}%' } }
            ],
            dataZoom: [
                { type: 'inside', xAxisIndex: [0, 1], start: 80, end: 100 },
                { show: true, xAxisIndex: [0, 1], type: 'slider', top: '92%', start: 80, end: 100, backgroundColor: '#e5e7eb', fillerColor: 'rgba(37, 99, 235, 0.2)', borderColor: '#d1d5db', handleStyle: { color: '#2563eb' }, textStyle: { color: '#0d1421' } }
            ],
            axisPointer: {
                link: [{ xAxisIndex: [0, 1] }]
            },
            series: [
                {
                    name: 'K线',
                    type: 'candlestick',
                    xAxisIndex: 0,
                    yAxisIndex: 0,
                    data: [],
                    itemStyle: { color: colors.up, color0: colors.down, borderColor: colors.up, borderColor0: colors.down }
                },
                {
                    name: '主动买卖比例',
                    type: 'line',
                    xAxisIndex: 0,
                    yAxisIndex: 1,
                    data: [],
                    lineStyle: { 
                        color: 'rgba(59, 130, 246, 0.9)', // 更淡的蓝色
                        width: 3.5
                    },
                    symbol: 'none',
                    smooth: true
                },
                { name: '买入额', type: 'bar', xAxisIndex: 1, yAxisIndex: 2, data: [], stack: 'volume', itemStyle: { color: colors.buy, opacity: 0.8 }, barWidth: '60%' },
                { name: '卖出额', type: 'bar', xAxisIndex: 1, yAxisIndex: 2, data: [], stack: 'volume', itemStyle: { color: colors.sell, opacity: 0.8 }, barWidth: '60%' },
            ]
        };
        myChart.setOption(option);

        async function fetchSymbols() {
            const res = await fetch('/api/symbols');
            const js = await res.json();
            if (js.success && Array.isArray(js.data)) {
                renderSymbols(js.data);
            }
        }
        function renderSymbols(symbols) {
            const list = document.getElementById('symbolsList');
            list.innerHTML = '';
            const filterText = document.getElementById('searchInput').value.trim().toUpperCase();
            symbols.filter(s => s.toUpperCase().includes(filterText)).forEach(s => {
                const li = document.createElement('li');
                li.textContent = s;
                li.onclick = () => selectSymbol(s);
                if (s === currentSymbol) li.classList.add('active');
                list.appendChild(li);
            });
        }
        // 修改选择币种时，不再开启实时深度流
        async function selectSymbol(symbol) {
            currentSymbol = symbol;
            document.querySelectorAll('.symbols-list li').forEach(li => {
                li.classList.toggle('active', li.textContent === symbol);
            });
            const titleElement = document.getElementById('title');
            const linkElement = titleElement.querySelector('a');
            linkElement.textContent = `专业K线图表 - ${symbol}`;
            linkElement.href = `https://www.binance.com/zh-CN/futures/${symbol}`;
            await loadData(currentCount);
        }

        // 删除页面关闭时清理WS的监听器
        // window.addEventListener('beforeunload', closeDepthWS);
        async function selectSymbol(symbol) {
            currentSymbol = symbol;
            document.querySelectorAll('.symbols-list li').forEach(li => {
                li.classList.toggle('active', li.textContent === symbol);
            });
            const titleElement = document.getElementById('title');
            const linkElement = titleElement.querySelector('a');
            linkElement.textContent = `专业K线图表 - ${symbol}`;
            linkElement.href = `https://www.binance.com/zh-CN/futures/${symbol}`;
            await loadData(currentCount);
        }
        
        // 删除websocket相关变量和函数
        // let depthWS = null;
        // const depthWindowMs = 3000;
        // const liveRecords = [];
        // let liveTimer = null;

        // function closeDepthWS() { ... }
        // function startDepthWS(symbol) { ... }
        async function loadData(count) {
            currentCount = count;
            const interval = document.getElementById('intervalSelect').value;
            currentInterval = interval;
            if (!currentSymbol) return;
            myChart.showLoading({ text: '正在加载数据...', color: '#2563eb', textColor: '#0d1421', maskColor: 'rgba(255, 255, 255, 0.6)' });
            try {
                const url = `/api/kline?symbol=${encodeURIComponent(currentSymbol)}&interval=${encodeURIComponent(interval)}&limit=${count}`;
                const res = await fetch(url);
                const js = await res.json();
                if (js.success && js.data) {
                    const d = js.data;
                    const klineData = d.klineData;
                    lastKlineData = klineData;
                    lastCandleReturns = Array.isArray(d.candleReturns) ? d.candleReturns : [];
                    const buyData = Array.isArray(d.buyAmounts) ? d.buyAmounts : [];
                    const sellData = Array.isArray(d.sellAmounts) ? d.sellAmounts.map(v => Math.abs(v)) : [];
                    const deltaData = Array.isArray(d.deltaRates) ? d.deltaRates : [];
                    
                    // 使用deltaRates作为主动买卖比例数据
                    const deltaRatesData = Array.isArray(d.deltaRates) ? d.deltaRates : [];
                    
                    // 更新主动买卖比例信息显示（基于deltaRates）
                    const avgDeltaRate = deltaRatesData.length > 0 ? 
                        (deltaRatesData.reduce((sum, val) => sum + (val || 0), 0) / deltaRatesData.length) : 0;
                    const currentDeltaRate = deltaRatesData.length > 0 ? 
                        (deltaRatesData[deltaRatesData.length - 1] || 0) : 0;
                    
                    const currentBuyRatioElement = document.getElementById('currentBuyRatio');
                    const avgBuyRatioElement = document.getElementById('avgBuyRatio');
                    const chartInfoElement = document.getElementById('chartInfo');
                    
                    if (currentBuyRatioElement) {
                        currentBuyRatioElement.textContent = `${(currentDeltaRate * 100).toFixed(2)}%`;
                    }
                    if (avgBuyRatioElement) {
                        avgBuyRatioElement.textContent = `${(avgDeltaRate * 100).toFixed(2)}%`;
                    }
                    if (chartInfoElement) {
                        chartInfoElement.style.display = 'block';
                    }
                    
                    const dMax = deltaData.reduce((m, v) => Math.max(m, (typeof v === 'number' ? v : Number(v) || 0)), 0);
                    const yMax = Math.max(2, Math.ceil(dMax * 1.1 * 100) / 100);
                    
                    // 为deltaRates数据使用更淡的蓝色
                    const deltaRatesSeriesData = deltaRatesData.map(rate => ({
                        value: rate * 100, // 转换为百分比显示
                        itemStyle: {
                            color: 'rgba(59, 130, 246, 0.4)'
                        },
                        lineStyle: {
                            color: 'rgba(59, 130, 246, 0.4)'
                        }
                    }));
                    
                    myChart.setOption({
                        xAxis: [{ data: d.dates }, { data: d.dates }],
                        series: [
                            { data: klineData },
                            { 
                                data: deltaRatesSeriesData,
                                lineStyle: { 
                                    color: 'rgba(59, 130, 246, 0.4)',
                                    width: 2
                                }
                            },
                            { data: buyData },
                            { data: sellData },
                            { data: deltaData }
                        ],
                        yAxis: [
                            {},
                            {},
                            {},
                            { min: 0, max: yMax }
                        ]
                    });
                }
            } catch (e) {
                console.error(e);
            } finally {
                myChart.hideLoading();
            }
        }

        // 控件事件
        document.querySelectorAll('.controls button[data-count]').forEach(btn => {
            btn.addEventListener('click', (event) => {
                document.querySelectorAll('.controls button[data-count]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                loadData(parseInt(btn.getAttribute('data-count')));
            });
        });
        document.getElementById('intervalSelect').addEventListener('change', () => loadData(currentCount));
        document.getElementById('refreshBtn').addEventListener('click', () => loadData(currentCount));
        document.getElementById('searchInput').addEventListener('input', () => fetchSymbols());

        // 初始化
        (async function init() {
            await fetchSymbols();
            // 自动选择第一个symbol，若无则使用默认 BTCUSDT
            const first = document.querySelector('#symbolsList li');
            if (first) {
                selectSymbol(first.textContent);
            } else {
                selectSymbol('BTCUSDT');
            }
        })();

        window.addEventListener('resize', function() { myChart.resize(); });
    </script>
</body>
</html>